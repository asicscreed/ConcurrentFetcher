'use strict';(function(l,t){"object"===typeof exports&&"undefined"!==typeof module?t(exports):"function"===typeof define&&define.amd?define(["exports"],t):(l="undefined"!==typeof globalThis?globalThis:l||self,t(l.ConcurrentFetcher={}))})(this,function(l){class t extends Error{constructor(a,b,m){super(a);this.name="FetchError";this.url=b;this.status=m}}class z extends SyntaxError{constructor(a,b){super(a);this.name="JsonParseError";this.url=b}}class A{constructor(){this.controllers=new Map}createSignal(a){const b=
new AbortController;this.controllers.set(a,b);return b.signal}abort(a){const b=this.controllers.get(a);b&&(b.abort(),this.controllers.delete(a))}abortAll(){this.controllers.forEach(a=>a.abort());this.controllers.clear()}}class C{constructor(a){this.requests=a;this.errors=[];this.abortManager=new A}delay(a){return new Promise(b=>setTimeout(b,a))}async fetchWithRetry(a,b,m,u,e,g,h,k,n,p=0){let x=200;try{var v="undefined"!==typeof Request&&a instanceof Request?a.clone():a,c=await fetch(v,b);x=c.status;
if(!c.ok)throw new t("Fetch HTTP error! status: "+c.status,a,c.status);let q="",w=0;c.headers&&c.headers.forEach((f,d)=>{"content-type"==d.toLowerCase()?q=f.toLowerCase():"content-length"==d.toLowerCase()&&(w=parseInt(f))});let r;if(q.includes("application/json"))r=u?JSON.stringify(await c.json()):await c.json();else if(q.includes("text/"))r=await c.text();else if(0<k&&w>k&&!c.bodyUsed&&c.body){const f=c.body.getReader();v=[];c=0;try{for(;;){const {done:y,value:B}=await f.read();if(y)break;v.push(B);
c+=B.length;n&&n(0,0,c,w)}const d=new Uint8Array(c);c=0;for(const y of v)d.set(y,c),c+=y.length;r=d}finally{f.releaseLock()}}else r=await c.blob();return r}catch(q){if(this.shouldRetryRequest(x,e,g,p))return p++,await this.delay(h),this.fetchWithRetry(a,b,m,u,e,g,h,k,n,p);throw q;}}async concurrentFetch({progressCallback:a}={}){const b=[];let m=0;const u=this.requests.map((e,g)=>{const {url:h,fetchOptions:k={},callback:n=null,requestId:p=null,forceText:x=!1,maxRetries:v=0,statusCodesToRetry:c=[[-99],
[0],[-99]],retryDelay:q=1E3,abortTimeout:w=0,cutoffAmount:r=0}=e,f=null!==p&&void 0!==p?p:g.toString();e={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json; charset: UTF-8"},signal:0<w?AbortSignal.any([this.abortManager.createSignal(f),AbortSignal.timeout(w)]):this.abortManager.createSignal(f),...k};return this.fetchWithRetry(h,e,f,x,v,c,q,r,a).then(d=>{n?n(f,d,null,this.abortManager):b[g]=d}).catch(d=>{if(d instanceof SyntaxError||d.name&&"SyntaxError"===d.name)d=new z(d.message,
h);n?n(f,null,d,this.abortManager):(this.errors.push({uniqueId:f,url:h,error:d}),b[g]=null)}).finally(()=>{m++;a&&a(f,m,this.requests.length,0,0)})});try{return await Promise.all(u),{results:b?b.filter(e=>null!==e):[],errors:this.errors}}catch(e){return this.errors.push({uniqueId:"unknown",url:"unknown",error:e}),this.requests.forEach(g=>{var h,k;return null===(h=g.callback)||void 0===h?void 0:h.call(g,null!==(k=g.requestId)&&void 0!==k?k:"unknown",null,e,this.abortManager)}),{results:[],errors:this.errors}}}shouldRetryRequest(a,
b,m,u){if(1>b-u)return!1;b=!1;for(const [e,g]of m)if(a>=e&&a<=g){b=!0;break}return b}abort(a){this.abortManager.abort(a)}abortAll(){this.abortManager.abortAll()}}l.AbortManager=A;l.ConcurrentFetcher=C;l.FetchError=t;l.JsonParseError=z});
