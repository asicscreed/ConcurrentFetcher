'use strict';(function(k,n){"object"===typeof exports&&"undefined"!==typeof module?n(exports):"function"===typeof define&&define.amd?define(["exports"],n):(k="undefined"!==typeof globalThis?globalThis:k||self,n(k.ConcurrentFetcher={}))})(this,function(k){class n extends Error{constructor(a,b,p){super(a);this.name="FetchError";this.url=b;this.status=p}}class r extends Error{constructor(a,b){super(a);this.name="JsonParseError";this.url=b}}class t{constructor(){this.controllers=new Map}createSignal(a){const b=
new AbortController;this.controllers.set(a,b);return b.signal}abort(a){const b=this.controllers.get(a);b&&(b.abort(),this.controllers.delete(a))}abortAll(){this.controllers.forEach(a=>a.abort());this.controllers.clear()}}class v{constructor(a){this.requests=a;this.errors=[];this.abortManager=new t}delay(a){return new Promise(b=>setTimeout(b,a))}async fetchWithRetry(a,b,p,q,e,g=0){try{const f="undefined"!==typeof Request&&a instanceof Request?a.clone():a,c=await fetch(f,b);if(!c.ok)throw new n(`Fetch HTTP error! status: ${c.status}`,
a,c.status);let h;const d=c.headers.get("content-type");d&&d.includes("application/json")?h=await c.json():d&&d.includes("text/html")?h=await c.text():d&&d.includes("text/plain")?h=await c.text():(d&&d.includes("image/")||d&&d.includes("application/octet-stream"),h=await c.blob());return h}catch(f){if(0<q)return q--,g++,await this.delay(e),this.fetchWithRetry(a,b,p,q,e,g);throw f;}}async concurrentFetch({progressCallback:a}={}){const b=[];let p=0;const q=this.requests.map((e,g)=>{const {url:f,fetchOptions:c=
{},callback:h=null,requestId:d=null,maxRetries:w=0,retryDelay:x=1E3,abortTimeout:u=0}=e,m=null!==d&&void 0!==d?d:g.toString();e=0<u?AbortSignal.any([this.abortManager.createSignal(m),AbortSignal.timeout(u)]):this.abortManager.createSignal(m);return this.fetchWithRetry(f,{...c,signal:e},m,w,x).then(l=>{h?h(m,l,null,this.abortManager):b[g]=l}).catch(l=>{l instanceof SyntaxError&&(l=new r(l.message,f));h?h(m,null,l,this.abortManager):(this.errors.push({uniqueId:m,url:f,error:l}),b[g]=null)}).finally(()=>
{p++;a&&a(m,p,this.requests.length)})});try{return await Promise.all(q),{results:b?b.filter(e=>null!==e):[],errors:this.errors}}catch(e){return this.errors.push({uniqueId:"unknown",url:"unknown",error:e}),this.requests.forEach(g=>{var f,c;return null===(f=g.callback)||void 0===f?void 0:f.call(g,null!==(c=g.requestId)&&void 0!==c?c:"unknown",null,e,this.abortManager)}),{results:[],errors:this.errors}}}abort(a){this.abortManager.abort(a)}abortAll(){this.abortManager.abortAll()}}k.AbortManager=t;k.ConcurrentFetcher=
v;k.FetchError=n;k.JsonParseError=r});
